<!DOCTYPE html>
<html>

<head>
	<title>Cellular Tapestries</title>
	<style>
		.grid-container {
			display: grid;
			grid-template-columns: 1fr 1fr 1fr;
			grid-gap: 10px;
			padding-bottom: 120px
		}
	</style>
</head>

<body>

	<h1>About</h1>
	<p>
		The tapestries are generated by space-time diagrams of 1-D cellular automata with n states. Select the ones you like and they will randomly mutate and cross breed with one another to produce more patterns. As you add tapestries to your gene pool they will automatically get saved. View your <a href="gene_pool.html">gene pool here</a>. 
	</p>
	
	<div>
	<button onclick ="reset_parents(true, true)">reset parents</button>
	<div class="grid-container">

		<div>
			<h3>Parent 1</h3>
			<canvas id="parent1" width="400" height="400"></canvas>
			<button id="parent1_remove" onclick ="delete_parent(parent1); hide_element('parent1_remove')">remove from gene pool</button>
			<button onclick ="reset_parents(true, false)">random reset</button>
			
			
		</div>
		<div>
			<h3>Parent 2</h3>
			<canvas id="parent2" width="400" height="400"></canvas>
			<button id="parent2_remove"onclick ="delete_parent(parent2); hide_element('parent2_remove')">remove from gene pool</button>
			<button onclick ="reset_parents(false, true)">random reset</button>
			
		</div>
	</div>
	</div>
	
	<div>
		<button onclick ="reset_children()">generate new children</button>
	<div class="grid-container">
		<div>
			<h3>Child 1</h3>
			<canvas id="child1" width="400" height="400"></canvas>
			<button id="child1_add" onclick ="select_child(current_children[0]); hide_element('child1_add')">add to gene pool</button>
			
		</div>
		<div>
			<h3>Child 2</h3>
			<canvas id="child2" width="400" height="400"></canvas>
			<button id="child2_add"onclick ="select_child(current_children[1]); hide_element('child2_add')">add to gene pool</button>
			
		</div>
		<div>
			<h3>Child 3</h3>
			<canvas id="child3" width="400" height="400"></canvas>
			<button id="child3_add" onclick ="select_child(current_children[2]); hide_element('child3_add')">add to gene pool</button>

		</div>
		<div>
			<h3>Child 4</h3>
			<canvas id="child4" width="400" height="400"></canvas>
			<button id="child4_add" onclick ="select_child(current_children[3]); hide_element('child4_add')">add to gene pool</button>

		</div>
	</div>
	</div>
	

	<script src="ca_engine.js"></script>
	<script src="view_handler.js"></script>
	<script>
		const num_children = 4;
		const children_canvases = [
			document.getElementById("child1"), 
			document.getElementById("child2"), 
			document.getElementById("child3"), 
			document.getElementById("child4")
		];
		
		let current_children = [];
		const pattern_base = [];

		
		for (let i = 0; i < 64; i++) {
			pattern_base.push(i);
		}
		
		const canvas1 = document.getElementById("parent1");
		const canvas2 = document.getElementById("parent2");
		env = new Environment(4, 4);
		
		env.load_data();
		
		const parent_selection = sample_list(env.cool_rules, 2);
		let parent1 = parent_selection[0];
		let parent2 = parent_selection[1];
		
		function hide_element(id) {
			document.getElementById(id).style.visibility = 'hidden';
		}
		
		function show_element(id) {
			document.getElementById(id).style.visibility = 'visible';
		}
		
		function reset_children() {
			const children_buttons = ["child1_add", "child2_add", "child3_add", "child4_add"];
			current_children = [];
			
			for (let i = 0; i < num_children; i++) {
				current_children.push(
					crossover_reproduce(parent1, parent2, sample_list(pattern_base, 32)).produce_mutated_child(env.mutation_rate)
				);
			}
		
			for (const [x, child_canvas] of children_canvases.entries()) {
				display_tapestry(child_canvas, generate_tapestry_data(current_children[x], generate_random_tape(env.num_states, 200), 200));
			}
			
			for (let child_button of children_buttons) {
				show_element(child_button);
			}
		}
				
		function reset_parents(first_reset, second_reset) {
			const new_selection = sample_list(env.cool_rules, 2);
			if (first_reset){
				parent1 = new_selection[0];
				show_element("parent1_remove");
			}
			
			if (second_reset) {
				parent2 = new_selection[1];
				show_element("parent2_remove");
			}

			display_tapestry(canvas1, generate_tapestry_data(parent1, generate_random_tape(env.num_states, 200), 200));
			display_tapestry(canvas2, generate_tapestry_data(parent2, generate_random_tape(env.num_states, 200), 200));
			
			reset_children();
		}
		
		function delete_parent(parent) {
			for (const [x, rule] of env.cool_rules.entries()) {
				if (rule === parent) {
					env.cool_rules.splice(x, 1);
				}
			}
			
			while (env.cool_rules.length <= 2) {
				env.cool_rules.push(generate_random_rule(env.num_states));
			}
			
			env.save_data();
		}
		
		function select_child(child) {
			env.cool_rules.push(child);
			env.save_data();
		}
		
		reset_parents();
	</script>

</body>
</html>
